#!/usr/bin/env bash

# SubMiner - All-in-one sentence mining overlay
# Copyright (C) 2024 sudacode
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#
# subminer - Wrapper script to launch MPV with SubMiner overlay
#
# Usage:
#   subminer [OPTIONS] [FILE|DIRECTORY]
#
# Options:
#   -b, --backend BACKEND  Display backend: auto, hyprland, sway, x11 (default: auto)
#   -d, --directory DIR    Directory to browse for videos (default: current directory)
#   -r, --recursive        Search for videos recursively
#   -p, --profile PROFILE  MPV profile to use
#   -T, --no-texthooker    Disable texthooker-ui server
#   -h, --help             Show this help message
#
# If FILE is provided directly, plays that file.
# If DIRECTORY is provided or no argument, opens rofi/fzf to select a video.

VIDEO_EXTENSIONS="mkv|mp4|avi|webm|mov|flv|wmv|m4v|ts|m2ts"

SEARCH_DIR="."
RECURSIVE=false
MPV_PROFILE=""
USE_TEXTHOOKER=true
USE_ROFI=false
BACKEND="auto"
SUBMINER_APPIMAGE_PATH="${SUBMINER_APPIMAGE_PATH:-}"
MPV_SOCKET_PATH="/tmp/subminer-socket"

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

show_help() {
    cat <<EOF
subminer - Launch MPV with SubMiner sentence mining overlay

Usage: $(basename "$0") [OPTIONS] [FILE|DIRECTORY]

Options:
  -b, --backend BACKEND  Display backend to use: auto, hyprland, sway, x11 (default: auto)
  -d, --directory DIR    Directory to browse for videos (default: current directory)
  -r, --recursive        Search for videos recursively
  -p, --profile PROFILE  MPV profile to use
  -R, --rofi             Use rofi file browser instead of fzf for video selection
  -T, --no-texthooker    Disable texthooker-ui server
  -h, --help             Show this help message

Environment:
  SUBMINER_APPIMAGE_PATH      Path to SubMiner AppImage/binary (optional override)

Examples:
  $(basename "$0")                        # Browse current directory with fzf
  $(basename "$0") -R                     # Browse current directory with rofi
  $(basename "$0") -d ~/Videos            # Browse ~/Videos
  $(basename "$0") -r -d ~/Anime          # Recursively browse ~/Anime
  $(basename "$0") video.mkv              # Play specific file
  $(basename "$0") -p gpu-hq video.mkv    # Play with gpu-hq profile
  $(basename "$0") -b x11 video.mkv       # Force x11 backend

EOF
}

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

detect_backend() {
    if [[ "$BACKEND" != "auto" ]]; then
        echo "$BACKEND"
        return
    fi

    if [[ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]]; then
        echo "hyprland"
    elif [[ -n "$SWAYSOCK" ]]; then
        echo "sway"
    elif [[ -n "$DISPLAY" ]]; then
        echo "x11"
    else
        log_error "Could not detect display backend"
        exit 1
    fi
}

check_dependencies() {
    local missing=()

    if ! command -v mpv &>/dev/null; then
        missing+=("mpv")
    fi

    if [[ "$USE_ROFI" = true ]]; then
        if ! command -v rofi &>/dev/null; then
            missing+=("rofi")
        fi
    else
        if ! command -v fzf &>/dev/null; then
            missing+=("fzf")
        fi
    fi

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing dependencies: ${missing[*]}"
        exit 1
    fi
}

find_videos() {
    local dir="$1"
    local find_opts=(-maxdepth 1)

    if [[ "$RECURSIVE" = true ]]; then
        find_opts=()
    fi

    find "$dir" "${find_opts[@]}" -type f -regextype posix-extended \
        -iregex ".*\.($VIDEO_EXTENSIONS)$" 2>/dev/null | sort -V
}

build_rofi_menu() {
    local dir="$1"

    while IFS= read -r video; do
        [[ -z "$video" ]] && continue
        local display_name
        if [[ "$RECURSIVE" = true ]]; then
            display_name=$(realpath --relative-to="$dir" "$video")
        else
            display_name=$(basename "$video")
        fi
        printf '%s\0icon\x1fthumbnail://%s\n' "$display_name" "$video"
    done < <(find_videos "$dir")
}

show_rofi_menu() {
    local dir="$1"
    local theme_path
    local realpath_result
    realpath_result=$(realpath "$0")
    theme_path="$(dirname "$realpath_result")/catppuccin-macchiato.rasi"

    local rofi_opts=(
        -dmenu
        -i
        -p "Select Video "
        -show-icons
        -theme "$theme_path"
    )

    local selection
    selection=$(build_rofi_menu "$dir" | rofi "${rofi_opts[@]}")

    if [[ -z "$selection" ]]; then
        return 0
    fi

    echo "$dir/$selection"
}

show_fzf_menu() {
    local dir="$1"

    local chafa_opts="--format=kitty"
    if [[ -n "$TMUX" ]]; then
        chafa_opts="--format=symbols --symbols=vhalf+wide --color-space=din99d"
    fi

    local preview_cmd
    if command -v chafa &>/dev/null; then
        preview_cmd="
            video={}
            thumb_dir=\"\$HOME/.cache/thumbnails/large\"
            video_uri=\"file://\$(realpath \"\$video\")\"
            thumb_hash=\$(echo -n \"\$video_uri\" | md5sum | cut -d' ' -f1)
            thumb_path=\"\$thumb_dir/\$thumb_hash.png\"

            get_thumb() {
                if [[ -f \"\$thumb_path\" ]]; then
                    echo \"\$thumb_path\"
                elif command -v ffmpegthumbnailer &>/dev/null; then
                    tmp=\"/tmp/subminer-preview.jpg\"
                    ffmpegthumbnailer -i \"\$video\" -o \"\$tmp\" -s 512 -q 5 2>/dev/null && echo \"\$tmp\"
                elif command -v ffmpeg &>/dev/null; then
                    tmp=\"/tmp/subminer-preview.jpg\"
                    ffmpeg -y -i \"\$video\" -ss 00:00:05 -vframes 1 -vf \"scale=512:-1\" \"\$tmp\" 2>/dev/null && echo \"\$tmp\"
                fi
            }

            thumb=\$(get_thumb)
            [[ -n \"\$thumb\" ]] && chafa $chafa_opts --size=\${FZF_PREVIEW_COLUMNS}x\${FZF_PREVIEW_LINES} \"\$thumb\" 2>/dev/null
        "
    else
        preview_cmd='echo "Install chafa for thumbnail preview"'
    fi

    local selection
    selection=$(find_videos "$dir" | fzf \
        --ansi \
        --reverse \
        --prompt="Select Video: " \
        --preview-window=right:50%:wrap \
        --preview "$preview_cmd")

    if [[ -z "$selection" ]]; then
        return 0
    fi

    echo "$selection"
}

find_appimage() {
    if [[ -n "$SUBMINER_APPIMAGE_PATH" ]] && [[ -x "$SUBMINER_APPIMAGE_PATH" ]]; then
        echo "$SUBMINER_APPIMAGE_PATH"
        return 0
    fi

    if [[ -x "$HOME/.local/bin/subminer.AppImage" ]]; then
        echo "$HOME/.local/bin/subminer.AppImage"
        return 0
    fi

    if [[ -x "/opt/subminer/subminer.AppImage" ]]; then
        echo "/opt/subminer/subminer.AppImage"
        return 0
    fi

    if command -v subminer &>/dev/null; then
        echo "subminer"
        return 0
    fi

    return 1
}

start_overlay() {
    local detected_backend
    detected_backend=$(detect_backend)
    log_info "Starting SubMiner overlay (backend: $detected_backend)..."

    local appimage
    appimage=$(find_appimage)
    if [[ -z "$appimage" ]]; then
        log_error "SubMiner AppImage not found. Install to ~/.local/bin/ or set SUBMINER_APPIMAGE_PATH"
        exit 1
    fi

    local args=(--start --backend "$detected_backend" --socket "$MPV_SOCKET_PATH")
    if [[ "$USE_TEXTHOOKER" = true ]]; then
        args+=(--texthooker)
    fi

    "$appimage" "${args[@]}" &
    OVERLAY_PID=$!
    sleep 2
}

# shellcheck disable=SC2329
stop_overlay() {
    if [[ -n "$OVERLAY_PID" ]]; then
        log_info "Stopping SubMiner overlay..."
        kill "$OVERLAY_PID" 2>/dev/null || true
        wait "$OVERLAY_PID" 2>/dev/null || true
    fi
}

play_video() {
    local video_file="$1"

    if [[ ! -f "$video_file" ]]; then
        log_error "Video file not found: $video_file"
        return 1
    fi

    log_info "Playing: $(basename "$video_file")"

    local mpv_opts=()
    if [[ -n "$MPV_PROFILE" ]]; then
        mpv_opts+=("--profile=$MPV_PROFILE")
    fi

    mpv_opts+=("--input-ipc-server=$MPV_SOCKET_PATH")

    mpv "${mpv_opts[@]}" "$video_file"

    return $?
}

# shellcheck disable=SC2329
cleanup() {
    stop_overlay
}

parse_args() {
    local opts
    opts=$(getopt -o b:d:rp:RTh --long backend:,directory:,recursive,profile:,rofi,no-texthooker,help -n "$(basename "$0")" -- "$@") || {
        show_help
        exit 1
    }

    eval set -- "$opts"

    while true; do
        case $1 in
        -b | --backend)
            case "$2" in
            auto | hyprland | sway | x11)
                BACKEND="$2"
                ;;
            *)
                log_error "Invalid backend: $2 (must be auto, hyprland, sway, or x11)"
                exit 1
                ;;
            esac
            shift 2
            ;;
        -d | --directory)
            SEARCH_DIR="$2"
            shift 2
            ;;
        -r | --recursive)
            RECURSIVE=true
            shift
            ;;
        -p | --profile)
            MPV_PROFILE="$2"
            shift 2
            ;;
        -R | --rofi)
            USE_ROFI=true
            shift
            ;;
        -T | --no-texthooker)
            USE_TEXTHOOKER=false
            shift
            ;;
        -h | --help)
            show_help
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
        esac
    done

    if [[ $# -gt 0 ]]; then
        local arg="$1"
        if [[ -f "$arg" ]]; then
            VIDEO_FILE="$arg"
        elif [[ -d "$arg" ]]; then
            SEARCH_DIR="$arg"
        else
            log_error "Not a file or directory: $arg"
            exit 1
        fi
    fi
}

main() {
    parse_args "$@"
    check_dependencies

    local video_to_play=""

    if [[ -n "$VIDEO_FILE" ]]; then
        if [[ ! -f "$VIDEO_FILE" ]]; then
            log_error "Video file not found: $VIDEO_FILE"
            exit 1
        fi
        video_to_play="$VIDEO_FILE"
    else
        SEARCH_DIR=$(realpath "$SEARCH_DIR")

        if [[ ! -d "$SEARCH_DIR" ]]; then
            log_error "Directory not found: $SEARCH_DIR"
            exit 1
        fi

        local video_count
        video_count=$(find_videos "$SEARCH_DIR" | wc -l)
        if [[ "$video_count" -eq 0 ]]; then
            log_error "No video files found in: $SEARCH_DIR"
            exit 1
        fi

        log_info "Browsing: $SEARCH_DIR ($video_count videos found)"
        if [[ "$USE_ROFI" = true ]]; then
            video_to_play=$(show_rofi_menu "$SEARCH_DIR")
        else
            video_to_play=$(show_fzf_menu "$SEARCH_DIR")
        fi
    fi

    if [[ -z "$video_to_play" ]]; then
        log_info "No video selected, exiting"
        exit 0
    fi

    trap cleanup EXIT INT TERM

    start_overlay

    play_video "$video_to_play"
    MPV_EXIT_CODE=$?

    exit "$MPV_EXIT_CODE"
}

main "$@"
